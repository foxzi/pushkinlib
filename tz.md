# Техническое задание (ТЗ)

## 1. Название и цель
**Проект:** Pushkinlib — web‑сервис просмотра локальной библиотеки книг по INPX‑индексу.
**Цель:** Предоставить быстрый и удобный доступ к каталогу книг на локальном диске: поиск по автору, серии и названию, просмотр краткого описания и обложек, а также публикация каталога через OPDS.

## 2. Термины и вводные
- **INPX** — индексный файл (или архив) для каталогов FB2/EPUB, содержащий метаданные (авторы, названия, серии, пути к файлам и т. п.).
- **Книга/издание** — файл форматов FB2/FB2.ZIP/EPUB (минимально FB2/FB2.ZIP).
- **OPDS** — Open Publication Distribution System. Обязательная поддержка OPDS 1.x (Atom XML). Поддержка OPDS 2.0 (JSON) — как опциональная.
- **Каталог** — корневая папка с книгами, может быть пустой.

## 3. Объем работ
Спроектировать и реализовать web‑сервис на Go, включающий:
1) HTTP API + SPA web‑интерфейс для просмотра каталога и поиска.
2) Парсинг INPX/INP, построение индекса (в памяти + on‑disk кэш).
3) Поиск по авторам, сериям, названиям (по умолчанию — по всем полям, доступным в INPX).
4) Просмотр карточки книги: краткое описание (annotation/description), список авторов, серия/номер в серии, год, теги/жанры, размер/формат, путь к файлу.
5) Просмотр обложек (если доступно: извлечение из FB2/EPUB или рядом лежащий файл обложки).
6) Интерфейс OPDS (разделы: «Новые», «Авторы», «Серии», «Жанры», «Поиск», «Алфавитные каталоги» и карточки книг с ссылками на скачивание).
7) Конфигурация из `.env`
8) HTTP Basic авторизация (вкл/выкл).
9) Локализация UI: RU как основной; EN — опционально.
10) Пакетная сборка: бинарь + Docker‑образ.

## 4. Функциональные требования
### 4.1 Веб‑интерфейс (SPA)
- Тип приложения: **Single Page Application (SPA)**.
- Архитектура маршрутов SPA:
  - `/` — поиск и «быстрые разделы» (Авторы, Серии, Жанры, Новые).
  - `/authors`, `/authors/:id`, `/series`, `/series/:id`, `/books/:id`.
- Строка поиска всегда видна (фиксирована в шапке). Дебаунс ввода (300–400 мс), подсветка совпадений. По умолчанию — поиск по **всем полям INPX** (автор, серия, название и т. д.).
- Списки: пагинация/бесконечная прокрутка (конфигурируемо). Сортировка: релевантность/алф./год. Фильтры: автор, серия, год, формат.
- Карточка книги: обложка (если есть), метаданные (авторы, серия+номер, жанры, год, формат, размер, путь), краткое описание, кнопки «Скачать»/«Открыть в читалке»*.
- Состояния:
  - Пустой каталог — дружелюбный экран + активный поиск.
  - Отсутствие обложки/описания — заглушки.
- *Примечание:* встроенный viewer FB2/EPUB не обязателен в MVP (кнопка «Скачать» обязательна).

### 4.1.1 Взаимодействие SPA ↔ API
- Все данные приходят из JSON API `/api/v1/*`.
- SPA **не** рендерится на сервере (SSR — не требуется).
- Ошибки API отображаются ненавязчивыми тостами/алертами.

### 4.1.2 Авторизация в SPA
- HTTP Basic Auth для API при включении флага в `.env`.
- SPA обращается к API с `Authorization: Basic <base64>`.
- На 401 — показывать модальный запрос логина/пароля (хранить в памяти сессии, не в localStorage).

### 4.2 OPDS 1.x (обязательно)
- Корневой фид: метаданные каталога (title из `.env`).
- Навигационные фиды: `Authors`, `Series`, `Genres`, `All Books`, `Search`.
- Пагинация через `link rel="next"`.
- Фид поиска: full‑text по тем же полям, что и web‑поиск.
- Entry книги:
  - `title`, `author`, `dc:language`, `category`, `issued`, `content`, `link` (скачивание, обложка), `id` — стабильный.

### 4.3 OPDS 2.0 (опционально)
- Корень и каталоги в JSON‑формате согласно спецификации. Включается параметром `.env`.

### 4.4 Авторизация
- HTTP Basic Auth включается/выключается через `.env`.

### 4.5 Конфигурация из `.env`
Пример:
```
PORT=8080
BOOKS_DIR=/data/books
INPX_PATH=/data/index/inpx/index.inpx
BASIC_AUTH_ENABLED=false
BASIC_AUTH_USER=reader
BASIC_AUTH_PASS=secret
CATALOG_TITLE=Pushkinlib
OPDS2_ENABLED=false
PAGE_SIZE=30
LOG_LEVEL=info
CACHE_DIR=/data/cache
```

### 4.6 Парсинг INPX и хранение индекса
- Поддержка INPX (zip) и INP (plain).
- Извлекаемые поля: автор(ы), название, серия, номер, жанры, год, путь, аннотация, размер, язык, id.
- Перечитывание INPX вручную (`/admin/reindex`) или периодически.

### 4.7 Поиск
- Нечувствительный к регистру, Unicode.
- Режимы: простой (все поля), расширенный (`author:"..."`).
- Ранжирование: точные совпадения выше.
- База индекса должна быть во встраиваемой БД, например sqlite, boltdb и т.д.

### 4.8 Обложки
- Извлечение из FB2/EPUB, рядом `*.jpg/png`, из zip.
- Кэш в `CACHE_DIR`.
- Превью: 200px, 600px.

### 4.9 Скачивание файлов
- Прямая отдача из `BOOKS_DIR`.
- White‑list расширений.

### 4.11 Безопасность
- Валидация путей, защита скачиваний, ограничения размеров.

## 5. API (черновой дизайн)
(описание `/api/v1/*`, `/opds/*`, `/admin/*`)

## 7. Архитектура и технологии
- Backend: Go 1.22+ (`chi`, `imaging` и т. д.)
- Frontend: SPA
- Модули backend: config, index, search, opds, web, cover, storage, auth.

## 8. UX‑требования
- SPA‑навигация без перезагрузок.
- Адаптивность ≥320px, мобильные устройства.
- Доступность: ARIA, контраст.

## 9. Обработка ошибок и крайние случаи
- INPX отсутствует — сервис работает с пустым индексом.
- Ошибки — дружелюбные сообщения.
